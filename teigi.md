脱税勇者 – Web アプリ版  
機能要件定義（Functional Requirements Only）

────────────────────
0. 前提
────────────────────
・ブラウザのみでプレイ（PC／タブレット／スマートフォン対応）。  
・フロントは SPA（React/Vue 等）、バックエンドは REST＋WebSocket を想定。  
・ゲームロジックはすべてサーバー側で確定し、クライアントは表示と入力に専念。  

────────────────────
1. アカウント & セッション
────────────────────
1.1 メール＋パスワード／SNS OAuth で新規登録・ログイン。  
1.2 ゲストプレイを許可（15 分以内にアカウント化を促す）。  
1.3 複数端末同時ログイン時は後勝ち or 並行プレイを選択可。  
1.4 自動セーブ：サーバー保存。手動セーブスロットは最大 5。  

────────────────────
2. ゲーム進行 & 章シナリオ
────────────────────
2.1 チュートリアル章をクリアすると章選択ハブが解放。  
2.2 各章開始時に「新税法」データをサーバーから取得し、固定 RNG Seed を付与。  
2.3 章クリア／撤退／ゲームオーバーのいずれかでセッションが終了し、結果が保存。  

────────────────────
3. 法律データ & 抜け穴ジェネレーター
────────────────────
3.1 Law API  
　GET /laws/active        … 現在施行中の法一覧  
　GET /law/{id}          … 条文全文＋メタ情報  
3.2 サーバー側 Loophole Generator  
　POST /laws/{id}/loopholes?playerSkill=xx  
　　→ Loophole JSON[] （risk, profit, synergyKey…）  
3.3 プレイヤーの「法解釈」アクションで Loophole 取得判定を実行し、結果を WebSocket Push。  
3.4 同一 Loophole を 1 章中に複数プレイヤーが共有しても衝突しない。  

────────────────────
4. 経済 & 税計算
────────────────────
4.1 戦闘勝利・クエスト完遂などの収入イベントはすべて  
　POST /economy/transaction へ送信。  
4.2 バックエンドは LawSystem → TaxCalculator → AuditSystem の順でネット収支を返却。  
4.3 プレイヤー側は UI を即時更新し、Audit Meter をアニメーション表示。  
4.4 預金（銀行 UI）と現金（所持金）を分離し、金利課税・預金封鎖イベントを実装。  

────────────────────
5. 監査（Audit）システム
────────────────────
5.1 Audit Meter がしきい値に達するとサーバーが強制的に  
　Event: {type:"AUDIT_BATTLE", enemyId:"CERBERUS"} を Push。  
5.2 監査バトルは通常戦闘 API と同一エンドポイントを使用。  
5.3 監査敗北時は追徴税や滞納度が Economy に自動反映。  

────────────────────
6. 戦闘システム
────────────────────
6.1 クライアントはステータスとコマンド入力を送信 →  
　POST /battle/{id}/turnAction  
　サーバーが全 RNG を確定し、ターン結果 JSON を返す。  
6.2 WebSocket によるリアルタイム HP 変動通知に対応。  
6.3 Auto-battle オプション：クライアントは “AUTO” を送信するだけ。  

────────────────────
7. インベントリ & 装備
────────────────────
7.1 GET /inventory で最新状態を取得。  
7.2 アイテム使用・装備変更は PATCH /inventory/{itemId}.  
7.3 “現物支給”は item.type = "RewardGoods" として保管。  
7.4 ブラックマーケット UI からの売却は  
　POST /market/sell で分割額を渡し、Audit 増分を即返却。  

────────────────────
8. UI 基本画面
────────────────────
8.1 メイン HUD  
　・HP/MP/Gold/AuditMeter  
　・現行法一覧ボタン  
8.2 条文ビューワ  
　・全文テキスト＋タグハイライト  
　・コピー不可（チート防止）  
8.3 Loophole Notebook  
　・リスク色分け、ソート／フィルタ  
8.4 年度末申告ダンジョン（タイマー付き）  
　・マス目クリック型 UI、ターン進行は AJAX。  

────────────────────
9. 通知
────────────────────
9.1 ブラウザ Push API：監査発生・章クリア時に通知。  
9.2 ゲーム内トースト：税率変動、Audit 増分など即時表示。  

────────────────────
10. マルチプレイヤー & ソーシャル
────────────────────
10.1 非同期ランキング：総資産・抜け穴発見数で週次更新。  
10.2 同時協力イベント（任意）：章ボスに協力攻撃するレイド。  
　・WebSocket 部屋（Max 20 人）、ダメージ貢献度公開。  
10.3 チャットは Stamp＋定型文のみ（誹謗中傷対策）。  

────────────────────
11. セキュリティ & 不正対策
────────────────────
11.1 すべての乱数はサーバーサイド。  
11.2 リクエスト署名トークンでリプレイ攻撃防止。  
11.3 プレイヤーの税データを日次でスナップショットし、巻き戻し機能を管理画面から実行可能。  

────────────────────
12. 管理者ポータル
────────────────────
12.1 法律 CRUD（テキスト、タグ、seed、施行日・失効日）。  
12.2 Loophole テンプレ管理（CSV インポート／エクスポート）。  
12.3 プレイヤー監査ログ閲覧・強制監査フラグ付与。  
12.4 統計ダッシュボード：脱税総額ヒートマップ、法別利用率。  

────────────────────
13. API 仕様（抜粋）
────────────────────
GET    /player/me  
PATCH  /player/skill            （技能ポイント振り分け）  
POST   /laws/vote               （ロビー活動ミニゲーム結果送信）  
POST   /audit/plea             （監査バトルでの弁明提出）  

────────────────────
14. ログ & 分析
────────────────────
14.1 章開始/終了、法閲覧回数、Loophole 使用時刻をイベントログ化。  
14.2 BigQuery 等にストリーム送信し、AB テストで経済バランスを調整可能に。  

────────────────────
15. 国際化
────────────────────
15.1 文言は i18n JSON。条文は Markdown+Front-Matter。  
15.2 数字フォーマット・通貨単位の Locale 切替え対応。  

────────────────────
16. アクセシビリティ
────────────────────
16.1 ARIA ラベル／キーボード操作完備。  
16.2 色覚サポート：AuditMeter の色を 3 パターンから選択。  

以上が Web アプリ版『脱税勇者』を実装するための機能的要件です。